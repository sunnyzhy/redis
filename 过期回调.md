# 过期回调

## 开启 Redis 键过期回调通知

Redis 默认是没有开启键过期监听功能的，需要手动在配置文件中修改。

### Linux 操作系统

1. 修改 redis 安装目录下的 redis.conf 配置文件，把 ```notify-keyspace-events ""``` 修改为 ```notify-keyspace-events "gxE"```
2. 重启 redis

### Windows 操作系统

1. 在安装目录下找到 redis.windows.conf 和 redis.windows-service.conf 两个文件，然后分别把这两个文件中的 ```notify-keyspace-events ""``` 修改为 ```notify-keyspace-events "gxE"```
2. 重启 redis

## 引入依赖

在 ```pom.xml``` 文件中引入 ```spring-boot-starter-data-redis``` 依赖：

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

## 配置 Redis 连接

在 ```application.yml``` 文件中配置 Redis 连接信息：

```yml
spring:
  data:
    redis:
      host: localhost
      port: 6379
      password: 
      database: 0
```

## 创建 Redis 过期事件监听器

### 监听指定的 db 键的过期事件

```java
@Configuration
public class RedisListenerConfig {
    @Bean
    RedisMessageListenerContainer container(RedisConnectionFactory connectionFactory) {
        RedisMessageListenerContainer container = new RedisMessageListenerContainer();
        container.setConnectionFactory(connectionFactory);
        // 监听 db0 键的过期事件
        container.addMessageListener(new RedisKeyExpirationListener(container), new PatternTopic("__keyevent@0__:expired"));
        return container;
    }

    class RedisKeyExpirationListener extends KeyExpirationEventMessageListener {
        public RedisKeyExpirationListener(RedisMessageListenerContainer listenerContainer) {
            super(listenerContainer);
        }

        @Override
        public void onMessage(Message message, byte[] pattern) {
            String expiredKey = message.toString();
            // TODO
            System.out.println("键过期：" + expiredKey);
        }
    }
}
```

### 监听所有的 db 键的过期事件

```java
@Configuration
public class RedisListenerConfig {
    @Bean
    RedisMessageListenerContainer container(RedisConnectionFactory connectionFactory) {
        RedisMessageListenerContainer container = new RedisMessageListenerContainer();
        container.setConnectionFactory(connectionFactory);
        return container;
    }
}

@Component
public class RedisKeyExpirationListener extends KeyExpirationEventMessageListener {
    public RedisKeyExpirationListener(RedisMessageListenerContainer listenerContainer) {
        super(listenerContainer);
    }

    @Override
    public void onMessage(Message message, byte[] pattern) {
        String expiredKey = message.toString();
        // TODO
        System.out.println("键过期：" + expiredKey);
    }
}
```
